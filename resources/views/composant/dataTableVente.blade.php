
<table id="search-table" class="w-70">
    <thead>
        <tr>
            <th>
                <span class="flex items-center max-w-sm">
                    Date
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
            <th>
                <span class="flex items-center max-w-sm">
                    Code
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
            <th>
                <span class="flex items-center max-w-sm">
                    Vendeur
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
            <th>
                <span class="flex items-center max-w-sm">
                    Client
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
            <th>
                <span class="flex items-center max-w-sm">
                    Produits
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
            <th>
                <span class="flex items-center">
                Paiement
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
            <th>
                <span class="flex items-center">
                Action
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
          
        </tr>
    </thead>
    <tbody>
        @php
            $recette = 0;
            $recetteFc = 0;
        @endphp
        @foreach ($data as $key=>$item )
        <tr>
            <td class="font-medium text-gray-900  dark:text-white">
                <div class="flex gap-2 sm:bloc">
                    {{$item->created_at}}                 
                </div>
            </td>
            <td class="font-medium text-gray-900  dark:text-white">
                <div class="flex gap-2 sm:bloc">
                    {{$item->code}}                 
                </div>
            </td>
            <td class="font-medium text-gray-900  dark:text-white">
                <div class="flex gap-2 sm:bloc">
                    @if($item->user!=null)
                        {{$item->user->name}}
                    @else
                        Utilisateur à problème
                    @endif                
                </div>
            </td>
            <td class="font-medium text-gray-900  dark:text-white">
               <div class="flex gap-2 sm:bloc">
                    {{$item->client->name }}<br/>
                     {{$item->client->tel }}              
                </div>
            </td>
            <td >
                @if ($item->compassassion->count()>0)
                    @php
                        $paiment = 0;
                    @endphp
                    @foreach ( $item->compassassion as $comp)
                    @php
                       // $paiment +=(float)$val->prixT;
                        $prix = preg_replace('/[^\d.]/', '', $comp->prixT);
                        if (is_numeric($prix)) {
                            $paiment += (float) $prix;
                        }
                    @endphp
                        <label class="block"> 
                            @if($comp->produit)
                            {{$comp->produit->libele}} : {{$comp->quantite}} pc
                            @else 
                                Produit retiré : {{$comp->quantite}} pc
                            @endif   
                        </label>
                    @endforeach
                @else 
                    @php
                        $paiment = 0;
                    @endphp
                    @foreach ( $item->venteProduit as $val)
                        @php
                        // $paiment +=(float)$val->prixT;
                            $prix = preg_replace('/[^\d.]/', '', $val->prixT);
                            if (is_numeric($prix)) {
                                $paiment += (float) $prix;
                            }
                        @endphp
                        <label for="" class="block"> {{$val->produit->libele}} : {{$val->quantite}} pc</label>
                    @endforeach
                   
                @endif
            </td>
            <td >
                @formaMille($paiment)
                @if($item->devise) 
                    {{ $item->devise->libele }} 
                @endif
                <input type="text" class="hidden totalPaie"  value="{{ $paiment *$item->updateTaux }}">
            </td>

            <td>
                @include('composant.actionLink', ['itemName'=>$item->code." ".$item->created_at." ".$prix ." ".$item->devise->libele,'seeRoute'=>'venteShow','seeParam'=>["vente"=>56745264509*$item->id, "depot"=>$item->depot_id*12], 'deleteRoute'=>"venteDelete",'deleteParam'=>56745264509*$item->id, 'editeRoute'=>"compCreate",'editParam'=>['depot'=>$item->depot->libele, 'vente_id'=>$item->id]])
            </td>
        </tr>
        @php
            $recette +=$paiment;
            $recetteFc +=$paiment *$item->updateTaux ;
        @endphp
        @endforeach
    </tbody>
</table>
@if(Auth::user()->user_role->role->libele =='Administrateur' || Auth::user()->user_role->role->libele=='Super admin')
<div class="flex p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400" role="alert">
  <svg class="shrink-0 inline w-4 h-4 me-3 mt-[2px]" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
    <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
  </svg>
  <span class="sr-only">Danger</span>
  <div>
    <span class="font-medium">Recette de toutes les ventes confondues du dépôt :  @formaMille($recetteFc) cdf</span>
      <ul class="mt-1.5 list-disc list-inside" id="listeDevise">
        @if (!empty($data))
            @foreach ($deviseList as $dev )
                @php
                    $montantDev = $recetteFc / $dev->taux;
                    number_format($montantDev, 2);
                @endphp
                <li>{{ $dev->libele }} ({{ $dev->taux }}) : @formaMille($montantDev)</li>
            @endforeach
        @endif
    </ul>
  </div>
</div>
@endif
@include('composant.modalDelete')
<script>
    


// document.addEventListener('DOMContentLoaded', () => {
//     // const data = @json($data);
//     // // console.log(data);
//     // if (typeof renderRecette === 'function') {
//     //     renderRecette(data);
//     //     console.log('fonction');
//     // }  
//     //modal suppression item
//     const deleteLink = document.querySelectorAll('#linkDelete');
    
//      deleteLink.forEach(link => {
//          link.addEventListener('click', (event) => {
//              event.preventDefault();
//              const hrefClicked = event.currentTarget.getAttribute('href');
//              const formDelete =document.getElementById('deleteForm');
//              const textDeleteItem =document.getElementById('textDeleteItem');
//              const itemName = event.currentTarget.getAttribute('itemName') ;
//              textDeleteItem.textContent= `Confirmer la suppression de la vente ${itemName}`;
//              formDelete.setAttribute('action',hrefClicked);
//          });
//      });
// });



// document.addEventListener("DOMContentLoaded", () => {
//     document.querySelectorAll(".delete-button").forEach(button => {
//         button.addEventListener("click", () => {
//             const itemName = button.dataset.itemName;
//             const deleteRoute = button.dataset.deleteRoute;

//             const formDelete = document.getElementById("deleteForm");
//             const message = document.getElementById("textDeleteItem");

//             if (formDelete) {
//                 formDelete.setAttribute("action", deleteRoute);
//             }

//             if (message) {
//                 message.textContent = `Etes-vous sûr de vouloir supprimer "${itemName}" ?`;
//             }

//         });
//     });
// });


    
    // const renderRecette = (data)=>{
    //     if(data.length > 0){
            
    //         const deviseList = @json($deviseList);
    //         let recette = 0;
    //         let recetteFc = 0;
    //         const ul = document.getElementById('listeDevise');
    //         const totalPaie = [...document.querySelectorAll('.totalPaie')];

    //         if(totalPaie){
    //             totalPaie.forEach(paie=>{
    //                 recetteFc +=parseFloat(paie.value);
    //                 console.log(paie.value, recetteFc)
    //             });
    //         }
            
    //         if(ul){
    //             deviseList.forEach(dev=>{
    //                 const li = `<li> ${dev.libele} => ${dev.taux} : ${parseFloat((recetteFc/dev.taux).toFixed(2))}</li>`
    //                 ul.innerHTML += li;
    //                 console.log(dev.taux, dev.libele);
    //             });
    //         }
    //     };

    // }
</script>