
<table id="search-table" class="w-70">
    <thead>
        <tr>
            <th>
                <span class="flex items-center max-w-sm">
                    Date
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
            <th>
                <span class="flex items-center max-w-sm">
                    Code
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
            <th>
                <span class="flex items-center max-w-sm">
                    Vendeur
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
            <th>
                <span class="flex items-center max-w-sm">
                    Client
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
            <th>
                <span class="flex items-center max-w-sm">
                    Produits
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
            <th>
                <span class="flex items-center">
                Paiement
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
            <th>
                <span class="flex items-center">
                Action
                    <svg class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                    </svg>
                </span>
            </th>
          
        </tr>
    </thead>
    <tbody>
        @php
            $recette = 0;
            $recetteFc = 0;
        @endphp
        @foreach ($data as $key=>$item )
        <tr>
            <td class="font-medium text-gray-900  dark:text-white">
                <div class="flex gap-2 sm:bloc">
                    {{$item->created_at}}  <br>
                    <svg width="12px" height="12px" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#000000">
                      <g id="SVGRepo_bgCarrier" stroke-width="0"/>
                      <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"/>
                      <g id="SVGRepo_iconCarrier">
                      <path d="M960 160h-291.2a160 160 0 0 0-313.6 0H64a32 32 0 0 0 0 64h896a32 32 0 0 0 0-64zM512 96a96 96 0 0 1 90.24 64h-180.48A96 96 0 0 1 512 96zM844.16 290.56a32 32 0 0 0-34.88 6.72A32 32 0 0 0 800 320a32 32 0 1 0 64 0 33.6 33.6 0 0 0-9.28-22.72 32 32 0 0 0-10.56-6.72zM832 416a32 32 0 0 0-32 32v96a32 32 0 0 0 64 0v-96a32 32 0 0 0-32-32zM832 640a32 32 0 0 0-32 32v224a32 32 0 0 1-32 32H256a32 32 0 0 1-32-32V320a32 32 0 0 0-64 0v576a96 96 0 0 0 96 96h512a96 96 0 0 0 96-96v-224a32 32 0 0 0-32-32z" fill="#231815"/>
                      <path d="M384 768V352a32 32 0 0 0-64 0v416a32 32 0 0 0 64 0zM544 768V352a32 32 0 0 0-64 0v416a32 32 0 0 0 64 0zM704 768V352a32 32 0 0 0-64 0v416a32 32 0 0 0 64 0z" fill="#231815"/>
                      </g>
                    </svg>
                    {{ $item->deleted_at }}               
                </div>
            </td>
            <td class="font-medium text-gray-900  dark:text-white">
                <div class="flex gap-2 sm:bloc">
                    {{$item->code}}                 
                </div>
            </td>
            <td class="font-medium text-gray-900  dark:text-white">
                <div class="flex gap-2 sm:bloc">
                    @if($item->user!=null)
                        {{$item->user->name}}
                    @else
                        Utilisateur à problème
                    @endif                
                </div>
            </td>
            <td class="font-medium text-gray-900  dark:text-white">
                <div class="flex gap-2 sm:bloc">
                    {{$item->client->name }}<br/>
                     {{$item->client->tel }}              
                </div>
            </td>
            <td >
                 
                @foreach ( $item->venteProduit as $val)
                    <label for="" class="block"> {{$val->produit->libele}} : {{$val->quantite}} pc</label>
                @endforeach
            </td>
            <td >
                @php
                    $paiment = 0;
                @endphp
                @foreach ( $item->venteProduit as $val)
                    @php
                        // $paiment +=(float)$val->prixT;
                            $prix = preg_replace('/[^\d.]/', '', $val->prixT);
                            if (is_numeric($prix)) {
                                $paiment += (float) $prix;
                            }
                    @endphp
                @endforeach
                @formaMille($paiment)
                @if($item->devise) 
                    {{ $item->devise->libele }} 
                @endif
                <input type="text" class="hidden totalPaie"  value="{{ $paiment *$item->updateTaux }}">
            </td>

            <td>
                @include('composant.actionLink', ['itemName'=>$item->code,'seeRoute'=>'venteShow','seeParam'=>56745264509*$item->id, 'deleteRoute'=>"forcedelete",'deleteParam'=>12*$item->id, 'editeRoute'=>"restore",'editParam'=>$item->id*12])
            </td>
        </tr>
        @php
            $recette +=$paiment;
            $recetteFc +=$paiment *$item->updateTaux ;
        @endphp
        @endforeach
    </tbody>
</table>
@if(Auth::user()->user_role->role->libele =='Administrateur' || Auth::user()->user_role->role->libele=='Super admin')
<div class="flex p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400" role="alert">
  <svg class="shrink-0 inline w-4 h-4 me-3 mt-[2px]" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
    <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
  </svg>
  <span class="sr-only">Danger</span>
  <div>
    <span class="font-medium">Recette pour ce tableau @formaMille($recetteFc) cdf</span>
      <ul class="mt-1.5 list-disc list-inside" id="listeDevise">
        
    </ul>
  </div>
</div>
@endif
@include('composant.modalDelete')
@include('composant.modalRestore')
<script>

document.addEventListener('DOMContentLoaded', () => {
    if (typeof renderRecette === 'function') {
        renderRecette();
    }  
});


   //modal suppression item
   const deleteLink = document.querySelectorAll('#linkDelete');

    deleteLink.forEach(link => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            const hrefClicked = event.currentTarget.getAttribute('href');
            const formDelete =document.getElementById('deleteForm');
            const textDeleteItem =document.getElementById('textDeleteItem');
            const itemName = event.currentTarget.getAttribute('itemName') ;
            textDeleteItem.textContent= `Forcer la suppression de la vente ${itemName} dans la corbeille ??`;
            formDelete.setAttribute('action',hrefClicked);
        });
    });
   //modal RESTORE item
   const restoreLink = document.querySelectorAll('#linkRestore');
    restoreLink.forEach(link => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            const hrefClicked = event.currentTarget.getAttribute('href');
            const formDelete =document.getElementById('restoreForm');
            const textDeleteItem =document.getElementById('textRestoreItem');
            const itemName = event.currentTarget.getAttribute('itemName') ;
            textDeleteItem.textContent= `Voulez-vous restaurer cette vente ${itemName} de la corbeille ??`;
            formDelete.setAttribute('action',hrefClicked);
        });
    });

    const data = @json($data);
    const renderRecette = ()=>{
        if(data.length > 0){
            const deviseList = @json($deviseList);
            let recette = 0;
            let recetteFc = 0;
            const ul = document.getElementById('listeDevise');
            const totalPaie = [...document.querySelectorAll('.totalPaie')];

            if(totalPaie){
                totalPaie.forEach(paie=>{
                    recetteFc +=parseFloat(paie.value);
                    // console.log(paie.value, recetteFc)
                });
            }
            
            if(ul){
                deviseList.forEach(dev=>{
                    const li = `<li> ${dev.libele} => ${dev.taux} : ${parseFloat((recetteFc/dev.taux).toFixed(2))}</li>`
                    ul.innerHTML += li;
                    // console.log(dev.taux, dev.libele);
                });
            }
        };

    }
</script>